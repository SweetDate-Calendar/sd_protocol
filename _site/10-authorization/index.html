<h1 id="sweetdate-authorization-signaturev1">SweetDate Authorization (SignatureV1)</h1>

<p>This document describes how to authenticate HTTP requests to the SweetDate REST API using <strong>SignatureV1</strong> (Ed25519 detached signatures).</p>

<blockquote>
  <p><strong>TL;DR</strong>: For every request (except <code class="language-plaintext highlighter-rouge">/health</code>), build a small canonical string, sign it with your <strong>Ed25519 private key</strong>, then send three headers: <code class="language-plaintext highlighter-rouge">sd-app-id</code>, <code class="language-plaintext highlighter-rouge">sd-timestamp</code>, and <code class="language-plaintext highlighter-rouge">sd-signature</code> (base64url, no padding).</p>
</blockquote>

<h2 id="base-url--protected-routes">Base URL &amp; Protected Routes</h2>

<ul>
  <li><strong>Base URL</strong>: <code class="language-plaintext highlighter-rouge">https://sweetdate.io/api/v1/</code></li>
  <li><strong>Dispatcher</strong> (payload parity with TCP): <code class="language-plaintext highlighter-rouge">POST /api/v1/dispatch</code></li>
  <li><strong>Health (no auth required)</strong>: <code class="language-plaintext highlighter-rouge">GET /health</code></li>
</ul>

<h2 id="required-headers">Required Headers</h2>

<table>
  <thead>
    <tr>
      <th>Header</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">sd-app-id</code></td>
      <td>Your application ID (e.g. <code class="language-plaintext highlighter-rouge">app_123…</code>).</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">sd-timestamp</code></td>
      <td>Unix epoch seconds at the time of the request (server allows ±300s).</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">sd-signature</code></td>
      <td>Base64url <strong>(no padding)</strong> Ed25519 signature of the canonical string.</td>
    </tr>
  </tbody>
</table>

<h2 id="canonical-string-v1">Canonical String (v1)</h2>

<p>Construct the canonical string exactly as follows (5 lines, with <code class="language-plaintext highlighter-rouge">\n</code> newlines):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>v1
&lt;METHOD&gt;
&lt;PATH_AND_QUERY&gt;
&lt;TIMESTAMP&gt;
-
</code></pre></div></div>

<p><strong>Rules</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">METHOD</code> is uppercased, e.g., <code class="language-plaintext highlighter-rouge">GET</code>, <code class="language-plaintext highlighter-rouge">POST</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">PATH_AND_QUERY</code> must include the <strong>leading slash</strong> and <strong>query string</strong> if present (e.g., <code class="language-plaintext highlighter-rouge">/whoami?x=1&amp;y=2</code>).</li>
  <li><code class="language-plaintext highlighter-rouge">TIMESTAMP</code> is <strong>seconds</strong> since epoch (UTC), not milliseconds.</li>
  <li>The last line is a literal dash (<code class="language-plaintext highlighter-rouge">-</code>) for v1 (no body hash).</li>
</ul>

<p>Example: <code class="language-plaintext highlighter-rouge">"v1\nGET\n/whoami?x=1&amp;y=2\n1724071234\n-"</code></p>

<h2 id="signature">Signature</h2>

<ul>
  <li>Algorithm: <strong>Ed25519</strong>, detached signature over the canonical string <strong>bytes</strong>.</li>
  <li>Encodings:
    <ul>
      <li>Send <code class="language-plaintext highlighter-rouge">sd-signature</code> as <strong>base64url</strong> without padding (<code class="language-plaintext highlighter-rouge">-</code> and <code class="language-plaintext highlighter-rouge">_</code> alphabet, strip <code class="language-plaintext highlighter-rouge">=</code>).</li>
      <li><code class="language-plaintext highlighter-rouge">sd-app-id</code> is your app identifier issued by SweetDate.</li>
    </ul>
  </li>
  <li>Server verification steps:
    <ol>
      <li>Validate headers exist and timestamp is within skew (default ±300s).</li>
      <li>Resolve your public key by <code class="language-plaintext highlighter-rouge">sd-app-id</code>.</li>
      <li>Rebuild the canonical string and verify the Ed25519 signature.</li>
    </ol>
  </li>
</ul>

<h2 id="example-get-whoami">Example: <code class="language-plaintext highlighter-rouge">GET /whoami</code></h2>

<p>Canonical (example <code class="language-plaintext highlighter-rouge">ts=1724064000</code>):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>v1
GET
/whoami
1724064000
-
</code></pre></div></div>

<p>Example request:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET https://sweetdate.io/api/v1/whoami
sd-app-id: app_7dc655cb-30ee-422f-b13a-f0a796c53879
sd-timestamp: 1724064000
sd-signature: q8W…base64url…
</code></pre></div></div>

<p>Example response:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ok"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"app_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"app_7dc655cb-30ee-422f-b13a-f0a796c53879"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="example-post-apiv1dispatch">Example: <code class="language-plaintext highlighter-rouge">POST /api/v1/dispatch</code></h2>

<p>Canonical (example <code class="language-plaintext highlighter-rouge">ts=1724064000</code>):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>v1
POST
/api/v1/dispatch
1724064000
-
</code></pre></div></div>

<p>Request:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST https://sweetdate.io/api/v1/dispatch
Content-Type: application/json
sd-app-id: app_7dc655cb-30ee-422f-b13a-f0a796c53879
sd-timestamp: 1724064000
sd-signature: q8W…base64url…

{
  "payload": {
    "cmd": "TENANTS.LIST",
    "limit": 25,
    "offset": 0
  }
}
</code></pre></div></div>

<h2 id="how-to-sign-openssl-pure-shell">How to Sign (OpenSSL, pure shell)</h2>

<blockquote>
  <p>Works on macOS/Linux with OpenSSL 3+. If you already have an Ed25519 private key, skip to <strong>Sign a request</strong>.</p>
</blockquote>

<h3 id="1-generate-a-keypair">1) Generate a keypair</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Private key (PEM)</span>
openssl genpkey <span class="nt">-algorithm</span> ed25519 <span class="nt">-out</span> sk.pem

<span class="c"># Public key (PEM)</span>
openssl pkey <span class="nt">-in</span> sk.pem <span class="nt">-pubout</span> <span class="nt">-out</span> pk.pem
</code></pre></div></div>

<blockquote>
  <p>You will register the <strong>public key</strong> with SweetDate (the server stores 32‑byte Ed25519 public keys).</p>
</blockquote>

<p>If you need the raw 32‑byte public key (for display or provisioning), you can extract it from the SPKI:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Extract the last 32 bytes (raw ed25519 public key) and encode as base64url (no padding)</span>
openssl pkey <span class="nt">-in</span> sk.pem <span class="nt">-pubout</span> <span class="nt">-outform</span> DER <span class="se">\</span>
| <span class="nb">tail</span> <span class="nt">-c</span> 32 <span class="se">\</span>
| <span class="nb">base64</span> | <span class="nb">tr</span> <span class="s1">'+/'</span> <span class="s1">'-_'</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'='</span>
</code></pre></div></div>

<h3 id="2-sign-a-request">2) Sign a request</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">BASE_URL</span><span class="o">=</span><span class="s2">"https://sweetdate.io"</span>
<span class="nv">METHOD</span><span class="o">=</span><span class="s2">"GET"</span>
<span class="nv">PATH</span><span class="o">=</span><span class="s2">"/api/v1/whoami"</span>        <span class="c"># include query if present, e.g. /api/v1/whoami?x=1</span>
<span class="nv">TS</span><span class="o">=</span><span class="si">$(</span><span class="nb">date</span> +%s<span class="si">)</span>               <span class="c"># seconds</span>

<span class="nv">CANONICAL</span><span class="o">=</span><span class="si">$(</span><span class="nb">printf</span> <span class="s2">"v1</span><span class="se">\n</span><span class="s2">%s</span><span class="se">\n</span><span class="s2">%s</span><span class="se">\n</span><span class="s2">%s</span><span class="se">\n</span><span class="s2">-</span><span class="se">\n</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$METHOD</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$PATH</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$TS</span><span class="s2">"</span><span class="si">)</span>

<span class="c"># Create Ed25519 detached signature (raw mode, no hash)</span>
<span class="nv">SIG_BIN</span><span class="o">=</span><span class="si">$(</span><span class="nb">printf</span> <span class="s2">"%s"</span> <span class="s2">"</span><span class="nv">$CANONICAL</span><span class="s2">"</span> | openssl pkeyutl <span class="nt">-sign</span> <span class="nt">-inkey</span> sk.pem <span class="nt">-rawin</span><span class="si">)</span>

<span class="c"># Base64url encode without padding</span>
<span class="nv">SIG_B64</span><span class="o">=</span><span class="si">$(</span><span class="nb">printf</span> <span class="s2">"%s"</span> <span class="s2">"</span><span class="nv">$SIG_BIN</span><span class="s2">"</span> | <span class="nb">base64</span> | <span class="nb">tr</span> <span class="s1">'+/'</span> <span class="s1">'-_'</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'='</span><span class="si">)</span>

<span class="c"># Call with curl</span>
curl <span class="nt">-i</span> <span class="s2">"</span><span class="nv">$BASE_URL$PATH</span><span class="s2">"</span> <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"sd-app-id: app_7dc655cb-30ee-422f-b13a-f0a796c53879"</span> <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"sd-timestamp: </span><span class="nv">$TS</span><span class="s2">"</span> <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"sd-signature: </span><span class="nv">$SIG_B64</span><span class="s2">"</span>
</code></pre></div></div>

<h3 id="3-dispatch-example-post">3) Dispatch example (POST)</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">BASE_URL</span><span class="o">=</span><span class="s2">"https://sweetdate.io"</span>
<span class="nv">METHOD</span><span class="o">=</span><span class="s2">"POST"</span>
<span class="nv">PATH</span><span class="o">=</span><span class="s2">"/api/v1/dispatch"</span>
<span class="nv">TS</span><span class="o">=</span><span class="si">$(</span><span class="nb">date</span> +%s<span class="si">)</span>

<span class="nv">CANONICAL</span><span class="o">=</span><span class="si">$(</span><span class="nb">printf</span> <span class="s2">"v1</span><span class="se">\n</span><span class="s2">%s</span><span class="se">\n</span><span class="s2">%s</span><span class="se">\n</span><span class="s2">%s</span><span class="se">\n</span><span class="s2">-</span><span class="se">\n</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$METHOD</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$PATH</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$TS</span><span class="s2">"</span><span class="si">)</span>
<span class="nv">SIG_BIN</span><span class="o">=</span><span class="si">$(</span><span class="nb">printf</span> <span class="s2">"%s"</span> <span class="s2">"</span><span class="nv">$CANONICAL</span><span class="s2">"</span> | openssl pkeyutl <span class="nt">-sign</span> <span class="nt">-inkey</span> sk.pem <span class="nt">-rawin</span><span class="si">)</span>
<span class="nv">SIG_B64</span><span class="o">=</span><span class="si">$(</span><span class="nb">printf</span> <span class="s2">"%s"</span> <span class="s2">"</span><span class="nv">$SIG_BIN</span><span class="s2">"</span> | <span class="nb">base64</span> | <span class="nb">tr</span> <span class="s1">'+/'</span> <span class="s1">'-_'</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'='</span><span class="si">)</span>

curl <span class="nt">-i</span> <span class="s2">"</span><span class="nv">$BASE_URL$PATH</span><span class="s2">"</span> <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"sd-app-id: app_7dc655cb-30ee-422f-b13a-f0a796c53879"</span> <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"sd-timestamp: </span><span class="nv">$TS</span><span class="s2">"</span> <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"sd-signature: </span><span class="nv">$SIG_B64</span><span class="s2">"</span> <span class="se">\</span>
  <span class="nt">--data</span> @- <span class="o">&lt;&lt;</span><span class="sh">'</span><span class="no">JSON</span><span class="sh">'
{
  "payload": {
    "cmd": "TENANTS.LIST",
    "limit": 25,
    "offset": 0
  }
}
</span><span class="no">JSON
</span></code></pre></div></div>

<h2 id="clock-skew">Clock Skew</h2>

<ul>
  <li>Default allowed skew is <strong>±300 seconds</strong>.</li>
  <li>If your system clock is off, signatures will be rejected with <code class="language-plaintext highlighter-rouge">401 unauthorized</code>.</li>
</ul>

<h2 id="error-responses">Error Responses</h2>

<ul>
  <li><code class="language-plaintext highlighter-rouge">401 unauthorized</code> — missing headers, bad/expired timestamp, key not found, or signature verify failed.</li>
  <li><code class="language-plaintext highlighter-rouge">404 not_found</code> — unknown route.</li>
  <li>Body is JSON; <code class="language-plaintext highlighter-rouge">{"error":"unauthorized"}</code> in the 401 case.</li>
</ul>

<h2 id="security-notes">Security Notes</h2>

<ul>
  <li><strong>Never</strong> share your private key. Store it securely (file permissions, secrets manager).</li>
  <li>Rotate credentials regularly.</li>
  <li>Prefer short‑lived tokens or key rotation for automation.</li>
  <li>Log <code class="language-plaintext highlighter-rouge">sd-app-id</code>, not signature values.</li>
</ul>

<h2 id="troubleshooting">Troubleshooting</h2>

<ul>
  <li><strong>401 with correct headers</strong> — check:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">sd-timestamp</code> is seconds (not ms) and within ±300s.</li>
      <li>Canonical string uses the exact <strong>path + query</strong> your request sends.</li>
      <li><code class="language-plaintext highlighter-rouge">METHOD</code> uppercased.</li>
      <li><code class="language-plaintext highlighter-rouge">sd-signature</code> is base64url <strong>without padding</strong> (<code class="language-plaintext highlighter-rouge">=</code> removed).</li>
      <li>Your public key registered for the given <code class="language-plaintext highlighter-rouge">sd-app-id</code> matches the private key used.</li>
    </ul>
  </li>
  <li><strong>Query parameters</strong> — must be present in the canonical path (e.g. <code class="language-plaintext highlighter-rouge">/whoami?x=1&amp;y=2</code>).</li>
</ul>

<hr />

<p><strong>Appendix: Example Canonical Strings</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># GET /api/v1/whoami at 1724064000
v1
GET
/api/v1/whoami
1724064000
-

# POST /api/v1/dispatch at 1724064001
v1
POST
/api/v1/dispatch
1724064001
-
</code></pre></div></div>
